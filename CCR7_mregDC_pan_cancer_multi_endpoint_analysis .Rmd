---
title: "CCR7+ mregDC Signature: Multi-Endpoint Pan-Cancer Survival Analysis"
author: "Survival Analysis Pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.width = 10, fig.height = 8)

# ============================================================
# ğŸ’¡ Signatureå®šä¹‰ - åªéœ€åœ¨æ­¤å¤„ä¿®æ”¹ï¼
# ============================================================
SIGNATURE_GENES <- c("CCR7", "LAMP3", "FSCN1")  # DCæ ‡å¿—åŸºå› 
NORMALIZER_GENE <- "CD3G"                        # Tç»†èƒæ ‡å‡†åŒ–åŸºå› 

# ç”Ÿæˆsignatureåç§°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
SIGNATURE_NAME <- paste0("(", paste(SIGNATURE_GENES, collapse = " Ã— "), ") / ", NORMALIZER_GENE)
cat("Signatureå®šä¹‰:", SIGNATURE_NAME, "\n")
# ============================================================

# ============================================================
# ğŸ¯ å¤šç»“å±€é…ç½®
# ============================================================
# 4ä¸ªæ ‡å‡†åŒ–ç”Ÿå­˜ç»“å±€ï¼ˆæ¥è‡ªLiu et al. Cell 2018ï¼‰
ENDPOINTS <- c("OS", "DSS", "DFI", "PFI")

# ç»“å±€ä¸­æ–‡å
ENDPOINT_NAMES_CN <- c(
  OS = "æ€»ç”Ÿå­˜æœŸ",
  DSS = "ç–¾ç—…ç‰¹å¼‚æ€§ç”Ÿå­˜",
  DFI = "æ— ç—…é—´æœŸ",
  PFI = "æ— è¿›å±•é—´æœŸ"
)

# ç»“å±€è‹±æ–‡å…¨ç§°
ENDPOINT_NAMES_EN <- c(
  OS = "Overall Survival",
  DSS = "Disease-Specific Survival",
  DFI = "Disease-Free Interval",
  PFI = "Progression-Free Interval"
)

# ç»“å±€æè¿°
ENDPOINT_DESC <- c(
  OS = "ä»è¯Šæ–­åˆ°ä»»ä½•åŸå› æ­»äº¡",
  DSS = "ä»è¯Šæ–­åˆ°ç–¾ç—…ç›¸å…³æ­»äº¡ï¼ˆæ’é™¤å…¶ä»–åŸå› ï¼‰",
  DFI = "ä»æ²»æ„ˆæ€§æ²»ç–—åˆ°ç–¾ç—…å¤å‘",
  PFI = "ä»è¯Šæ–­åˆ°ç–¾ç—…è¿›å±•æˆ–æ­»äº¡"
)

cat("\næœ¬åˆ†æå°†åŒæ—¶åˆ†æä»¥ä¸‹4ä¸ªç”Ÿå­˜ç»“å±€:\n")
for(ep in ENDPOINTS) {
  cat("  âœ“", ep, "(", ENDPOINT_NAMES_CN[ep], "):", ENDPOINT_DESC[ep], "\n")
}
cat("\næ•°æ®æ¥æº: Liu et al. Cell 2018 - TCGA Pan-Cancer Atlas\n")
# ============================================================

# åˆ›å»ºè¾“å‡ºæ–‡ä»¶å¤¹
dir.create("data_xena", showWarnings = FALSE)
dir.create("results_multi_endpoint", showWarnings = FALSE)
dir.create("figures_multi_endpoint", showWarnings = FALSE)

# ä¸ºæ¯ä¸ªç»“å±€åˆ›å»ºå­æ–‡ä»¶å¤¹
for(ep in ENDPOINTS) {
  dir.create(file.path("results_multi_endpoint", ep), showWarnings = FALSE)
  dir.create(file.path("figures_multi_endpoint", ep), showWarnings = FALSE)
}
```

# é¡¹ç›®ç®€ä»‹

æœ¬åˆ†æä½¿ç”¨**UCSC Xena TCGA Pan-Cancer Atlasæ•°æ®**ï¼Œå¯¹æ‰€æœ‰TCGAç™Œç—‡ç±»å‹è¿›è¡ŒCCR7+ mregDC signatureçš„**å¤šç»“å±€ç”Ÿå­˜åˆ†æ**ã€‚

## ğŸ¯ å¤šç»“å±€åˆ†æç‰¹ç‚¹

- ğŸ“Š **4ä¸ªæ ‡å‡†åŒ–ç»“å±€** - OS, DSS, DFI, PFIï¼ˆLiu et al. Cell 2018ï¼‰
- ğŸ” **å…¨é¢è¯„ä¼°** - ä¸€æ¬¡åˆ†æäº†è§£signatureåœ¨ä¸åŒä¸´åºŠç»“å±€ä¸­çš„é¢„åä»·å€¼
- ğŸ“ˆ **å¯¹æ¯”åˆ†æ** - è¯†åˆ«åœ¨å¤šä¸ªç»“å±€ä¸­éƒ½æ˜¾è‘—çš„ç™Œç—‡ç±»å‹
- âœ… **é«˜è´¨é‡æ•°æ®** - TCGA Pan-Cancer Atlasæ ‡å‡†åŒ–å¤„ç†

## CCR7+ mregDC Signature å®šä¹‰

```{r display_signature, echo=FALSE}
cat("CCR7+mregDC signature =", SIGNATURE_NAME, "\n\n")
cat("ç”Ÿå­˜ç»“å±€:\n")
for(ep in ENDPOINTS) {
  cat("  -", ep, "(", ENDPOINT_NAMES_CN[ep], "):", ENDPOINT_DESC[ep], "\n")
}
```

---

# 1. ç¯å¢ƒè®¾ç½®

```{r load_libraries, message=FALSE}
# åŠ è½½æ‰€éœ€çš„åŒ…
library(survival)
library(survminer)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)

cat("âœ“ æ‰€æœ‰åŒ…åŠ è½½æˆåŠŸï¼\n")
```

---

# 2. ä¸‹è½½Pan-Canceræ•°æ®

```{r download_data}
cat("å¼€å§‹ä¸‹è½½TCGA Pan-Canceræ•°æ®...\n")
cat("è¿™æ˜¯ä¸€æ¬¡æ€§ä¸‹è½½ï¼ŒåŒ…å«æ‰€æœ‰ç™Œç—‡ç±»å‹çš„æ•°æ®\n\n")

# å¢åŠ ä¸‹è½½è¶…æ—¶æ—¶é—´
options(timeout = 600)

# æ–‡ä»¶URLs
exp_url <- "https://tcga-pancan-atlas-hub.s3.us-east-1.amazonaws.com/download/EB%2B%2BAdjustPANCAN_IlluminaHiSeq_RNASeqV2.geneExp.xena.gz"
exp_file <- "data_xena/PANCAN_expression.tsv.gz"

clin_url <- "https://tcga-pancan-atlas-hub.s3.us-east-1.amazonaws.com/download/Survival_SupplementalTable_S1_20171025_xena_sp"
clin_file <- "data_xena/PANCAN_survival.tsv"

phenotype_url <- "https://tcga-pancan-atlas-hub.s3.us-east-1.amazonaws.com/download/TCGA_phenotype_denseDataOnlyDownload.tsv.gz"
phenotype_file <- "data_xena/PANCAN_phenotype.tsv.gz"

# å¸¦é‡è¯•çš„ä¸‹è½½å‡½æ•°
download_with_retry <- function(url, destfile, desc = "æ–‡ä»¶", max_retries = 3) {
  if(file.exists(destfile)) {
    current_size_mb <- file.size(destfile) / (1024 * 1024)
    cat("  ", desc, "å·²å­˜åœ¨ (", round(current_size_mb, 3), "MB)ï¼Œè·³è¿‡ä¸‹è½½\n")
    return(TRUE)
  }

  cat("  ä¸‹è½½", desc, "...\n")
  use_curl <- Sys.which("curl") != ""

  for(retry in 1:max_retries) {
    result <- tryCatch({
      if(use_curl) {
        exit_code <- system2("curl", args = c("-L", "-o", destfile, url,
                            "--connect-timeout", "60", "--max-time", "1200",
                            "--retry", "3", "--retry-delay", "10"),
                            stdout = FALSE, stderr = FALSE)
        exit_code == 0 && file.exists(destfile)
      } else {
        download.file(url, destfile, mode = "wb", quiet = FALSE)
        file.exists(destfile)
      }
    }, error = function(e) { FALSE })

    if(result) {
      cat("    âœ“", desc, "ä¸‹è½½å®Œæˆ\n")
      return(TRUE)
    }
    if(retry < max_retries) {
      cat("    é‡è¯•", retry + 1, "/", max_retries, "...\n")
      Sys.sleep(retry * 10)
    }
  }
  stop(paste("ä¸‹è½½å¤±è´¥:", desc))
}

# ä¸‹è½½æ–‡ä»¶
cat("\n1. è¡¨è¾¾æ•°æ® (~315MB)\n")
download_with_retry(exp_url, exp_file, "è¡¨è¾¾æ•°æ®", max_retries = 5)

cat("\n2. ä¸´åºŠæ•°æ® (~2MB)\n")
download_with_retry(clin_url, clin_file, "ä¸´åºŠæ•°æ®", max_retries = 3)

cat("\n3. è¡¨å‹æ•°æ® (~60KB)\n")
download_with_retry(phenotype_url, phenotype_file, "è¡¨å‹æ•°æ®", max_retries = 3)

cat("\nâœ“ æ‰€æœ‰æ•°æ®ä¸‹è½½å®Œæˆï¼\n")
```

---

# 3. è¯»å–å’Œå‡†å¤‡æ•°æ®

```{r load_data}
cat("è¯»å–æ•°æ®...\n")

# è¯»å–è¡¨è¾¾æ•°æ®
cat("1. è¯»å–è¡¨è¾¾æ•°æ®...\n")
exp_data_raw <- read.table(gzfile(exp_file), header = TRUE, sep = "\t",
                           check.names = FALSE, stringsAsFactors = FALSE)

gene_names <- exp_data_raw[,1]
if(any(duplicated(gene_names))) {
  n_dup <- sum(duplicated(gene_names))
  cat("   å‘ç°", n_dup, "ä¸ªé‡å¤çš„åŸºå› åï¼Œå°†æ·»åŠ åç¼€å¤„ç†\n")
  gene_names <- make.unique(as.character(gene_names))
}

exp_data <- exp_data_raw[,-1]
rownames(exp_data) <- gene_names
cat("   è¡¨è¾¾çŸ©é˜µ:", nrow(exp_data), "åŸºå›  Ã—", ncol(exp_data), "æ ·æœ¬\n")

# è¯»å–ä¸´åºŠæ•°æ®
cat("2. è¯»å–ä¸´åºŠæ•°æ®...\n")
clin_data <- read.table(clin_file, header = TRUE, sep = "\t",
                        stringsAsFactors = FALSE)
cat("   ä¸´åºŠæ•°æ®:", nrow(clin_data), "æ ·æœ¬\n")

# æ£€æŸ¥æ‰€æœ‰ç»“å±€çš„å¯ç”¨æ€§
cat("\n   æ£€æŸ¥ç”Ÿå­˜ç»“å±€å¯ç”¨æ€§:\n")
for(ep in ENDPOINTS) {
  time_col <- paste0(ep, ".time")
  event_col <- ep

  has_time <- time_col %in% colnames(clin_data)
  has_event <- event_col %in% colnames(clin_data)

  if(has_time && has_event) {
    n_samples <- sum(!is.na(clin_data[[time_col]]) & !is.na(clin_data[[event_col]]))
    cat("     âœ“", ep, "(", ENDPOINT_NAMES_CN[ep], "):", n_samples, "æ ·æœ¬å¯ç”¨\n")
  } else {
    cat("     âœ—", ep, "æ•°æ®ç¼ºå¤±\n")
  }
}

cat("\nâœ“ æ‰€æœ‰æ•°æ®è¯»å–å®Œæˆï¼\n")
```

---

# 4. å®šä¹‰åˆ†æå‡½æ•°

```{r define_functions}
# ç™Œç—‡ç±»å‹ä¸­æ–‡å
cancer_names_cn <- c(
  ACC = "è‚¾ä¸Šè…ºçš®è´¨ç™Œ", BLCA = "è†€èƒ±ç™Œ", BRCA = "ä¹³è…ºç™Œ",
  CESC = "å®«é¢ˆç™Œ", CHOL = "èƒ†ç®¡ç™Œ", COAD = "ç»“è‚ ç™Œ",
  DLBC = "å¼¥æ¼«å¤§Bç»†èƒæ·‹å·´ç˜¤", ESCA = "é£Ÿç®¡ç™Œ", GBM = "èƒ¶è´¨æ¯ç»†èƒç˜¤",
  HNSC = "å¤´é¢ˆé³ç™Œ", KICH = "è‚¾å«Œè‰²ç»†èƒç™Œ", KIRC = "è‚¾é€æ˜ç»†èƒç™Œ",
  KIRP = "è‚¾ä¹³å¤´çŠ¶ç»†èƒç™Œ", LAML = "æ€¥æ€§é«“ç³»ç™½è¡€ç—…", LGG = "ä½çº§åˆ«èƒ¶è´¨ç˜¤",
  LIHC = "è‚ç™Œ", LUAD = "è‚ºè…ºç™Œ", LUSC = "è‚ºé³ç™Œ",
  MESO = "é—´çš®ç˜¤", OV = "åµå·¢ç™Œ", PAAD = "èƒ°è…ºç™Œ",
  PCPG = "å—œé“¬ç»†èƒç˜¤", PRAD = "å‰åˆ—è…ºç™Œ", READ = "ç›´è‚ ç™Œ",
  SARC = "è‚‰ç˜¤", SKCM = "é»‘è‰²ç´ ç˜¤", STAD = "èƒƒç™Œ",
  TGCT = "ç¾ä¸¸ç™Œ", THCA = "ç”²çŠ¶è…ºç™Œ", THYM = "èƒ¸è…ºç˜¤",
  UCEC = "å­å®«å†…è†œç™Œ", UCS = "å­å®«ç™Œè‚‰ç˜¤", UVM = "è‘¡è„è†œé»‘è‰²ç´ ç˜¤"
)

# å‡½æ•°ï¼šè®¡ç®—signature score
# âš ï¸ é‡è¦ï¼šgene_expressions å¿…é¡»æ˜¯TPMç©ºé—´çš„æ•°æ®
# ä¹˜ç§¯æ³•çš„ç”Ÿç‰©å­¦æ„ä¹‰ï¼šåœ¨åŸå§‹è¡¨è¾¾é‡ç©ºé—´ï¼ˆTPMï¼‰è¿›è¡Œä¹˜æ³•
# å…¬å¼ï¼šSignature = (CCR7_TPM Ã— LAMP3_TPM Ã— FSCN1_TPM) / CD3G_TPM
calculate_signature <- function(gene_expressions) {
  pseudocount <- 0.1  # é¿å…é™¤é›¶ï¼Œé˜²æ­¢æç«¯å€¼

  # è®¡ç®—åˆ†å­ï¼šæ‰€æœ‰signatureåŸºå› çš„ä¹˜ç§¯ï¼ˆåœ¨TPMç©ºé—´ï¼‰
  numerator <- 1
  for(gene in SIGNATURE_GENES) {
    numerator <- numerator * (gene_expressions[[gene]] + pseudocount)
  }

  # è®¡ç®—åˆ†æ¯ï¼šæ ‡å‡†åŒ–åŸºå› è¡¨è¾¾ï¼ˆåœ¨TPMç©ºé—´ï¼‰
  denominator <- gene_expressions[[NORMALIZER_GENE]] + pseudocount

  # è¿”å›signature score
  # ç»“æœå•ä½ï¼šç›¸å¯¹è¡¨è¾¾é‡æ¯”å€¼ï¼ˆæ— é‡çº²ï¼‰
  return(numerator / denominator)
}

# å‡½æ•°ï¼šåˆ†æå•ä¸ªç™Œç—‡ç±»å‹çš„å•ä¸ªç»“å±€
process_single_endpoint <- function(cancer_code, endpoint, exp_matrix, clinical) {

  ep_cn <- ENDPOINT_NAMES_CN[endpoint]
  ep_en <- ENDPOINT_NAMES_EN[endpoint]

  cat("\n  --- ", endpoint, " (", ep_cn, ") ---\n", sep="")

  result <- tryCatch({

    # è·å–è¯¥ç»“å±€çš„åˆ—å
    time_col <- paste0(endpoint, ".time")
    event_col <- endpoint

    # ç­›é€‰æ ·æœ¬
    cancer_samples <- clinical %>%
      filter(cancer.type.abbreviation == cancer_code) %>%
      pull(sample)

    if(length(cancer_samples) == 0) {
      stop("æœªæ‰¾åˆ°æ ·æœ¬")
    }

    cancer_samples <- intersect(cancer_samples, colnames(exp_matrix))

    if(length(cancer_samples) < 30) {
      stop("æ ·æœ¬æ•°å¤ªå°‘ (<30)")
    }

    exp_subset <- exp_matrix[, cancer_samples, drop = FALSE]

    # æå–signatureåŸºå› 
    all_genes <- c(SIGNATURE_GENES, NORMALIZER_GENE)
    genes_found <- all_genes %in% rownames(exp_subset)

    if(!all(genes_found)) {
      missing <- all_genes[!genes_found]
      stop(paste("ç¼ºå¤±åŸºå› :", paste(missing, collapse = ", ")))
    }

    # æå–åŸºå› è¡¨è¾¾å¹¶è½¬æ¢åˆ°TPMç©ºé—´
    # âš ï¸ å…³é”®æ­¥éª¤ï¼šUCSC Xenaæ•°æ®æ˜¯log2(TPM+1)æ ¼å¼
    # å¿…é¡»è½¬å›TPMç©ºé—´å†åšä¹˜æ³•è¿ç®—ï¼Œå¦åˆ™ç”Ÿç‰©å­¦æ„ä¹‰é”™è¯¯ï¼
    gene_expressions <- list()
    for(gene in all_genes) {
      # åŸå§‹æ•°æ®ï¼šlog2(TPM+1)
      log_values <- as.numeric(exp_subset[gene, ])

      # è½¬å›TPMç©ºé—´ï¼šTPM = 2^log2(TPM+1) - 1
      # è¿™æ˜¯å¿…é¡»çš„ï¼ä¹˜ç§¯æ³•åªèƒ½åœ¨åŸå§‹TPMç©ºé—´è¿›è¡Œ
      gene_expressions[[gene]] <- 2^log_values - 1
    }

    # éªŒè¯ï¼šæ˜¾ç¤ºè½¬æ¢åçš„æ•°æ®èŒƒå›´ï¼ˆåº”è¯¥æ˜¯TPMï¼Œéè´Ÿæ•°ï¼‰
    # åŒæ—¶è®°å½•å¼‚å¸¸æƒ…å†µç”¨äºè´¨é‡æ§åˆ¶
    tpm_anomalies <- c()
    for(gene in all_genes) {
      gene_range <- range(gene_expressions[[gene]], na.rm = TRUE)
      cat("    ", gene, " TPM: [", round(gene_range[1], 2), ", ",
          round(gene_range[2], 2), "]", sep="")

      # æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å€¼å¹¶è®°å½•
      if(gene_range[1] < 0) {
        cat(" âš ï¸è´Ÿæ•°!")
        tpm_anomalies <- c(tpm_anomalies, paste0(gene, ":è´Ÿæ•°(", round(gene_range[1], 2), ")"))
      }
      if(gene_range[2] > 1e5) {
        cat(" âš ï¸å¼‚å¸¸å¤§!")
        tpm_anomalies <- c(tpm_anomalies, paste0(gene, ":å¼‚å¸¸å¤§(", round(gene_range[2], 0), ")"))
      }
      cat("\n")
    }

    # æ±‡æ€»å¼‚å¸¸çŠ¶æ€
    has_anomaly <- length(tpm_anomalies) > 0
    anomaly_summary <- if(has_anomaly) paste(tpm_anomalies, collapse = "; ") else "æ­£å¸¸"

    # è®¡ç®—signatureï¼ˆåœ¨TPMç©ºé—´ï¼‰
    signature_scores <- calculate_signature(gene_expressions)

    results_df <- data.frame(
      sample_id = cancer_samples,
      CCR7_mregDC_signature = signature_scores,
      stringsAsFactors = FALSE
    )

    # åˆå¹¶ä¸´åºŠæ•°æ®
    clinical_clean <- clinical %>%
      filter(cancer.type.abbreviation == cancer_code) %>%
      select(sample, all_of(time_col), all_of(event_col)) %>%
      rename(sample_id = sample, time = all_of(time_col), event = all_of(event_col)) %>%
      mutate(
        time = as.numeric(time),
        event = as.numeric(event)
      )

    merged_data <- results_df %>%
      inner_join(clinical_clean, by = "sample_id") %>%
      filter(!is.na(CCR7_mregDC_signature), !is.na(time), time > 0)

    valid_samples <- nrow(merged_data)

    if(valid_samples < 20) {
      stop("æœ‰æ•ˆæ ·æœ¬æ•°å¤ªå°‘ (<20)")
    }

    # åˆ†ç»„
    median_sig <- median(merged_data$CCR7_mregDC_signature, na.rm = TRUE)
    merged_data$group <- ifelse(merged_data$CCR7_mregDC_signature >= median_sig,
                                "High", "Low")

    # ç”Ÿå­˜åˆ†æ
    if(sum(merged_data$event) < 3) {
      stop("äº‹ä»¶æ•°å¤ªå°‘ (<3)")
    }

    # Kaplan-Meieråˆ†æ
    fit <- survfit(Surv(time, event) ~ group, data = merged_data)

    # Log-rankæ£€éªŒ
    surv_diff <- survdiff(Surv(time, event) ~ group, data = merged_data)
    p_value <- 1 - pchisq(surv_diff$chisq, df = 1)

    # Coxå›å½’ï¼ˆä½¿ç”¨åˆ†ç»„å˜é‡ High vs Lowï¼Œä»¥ Low ä¸ºå‚è€ƒç»„ï¼‰
    merged_data$group <- factor(merged_data$group, levels = c("Low", "High"))
    cox_uni <- coxph(Surv(time, event) ~ group, data = merged_data)
    cox_summary <- summary(cox_uni)
    hr <- as.numeric(exp(coef(cox_uni)))  # HR > 1 è¡¨ç¤º High ç»„é£é™©æ›´é«˜
    cox_pval <- as.numeric(cox_summary$coefficients[, "Pr(>|z|)"])

    # è®¡ç®—æ¯ç»„çš„äº‹ä»¶æ•°ï¼ˆç”¨äºè´¨é‡æ§åˆ¶ï¼‰
    events_high <- sum(merged_data$event[merged_data$group == "High"])
    events_low <- sum(merged_data$event[merged_data$group == "Low"])
    total_events <- sum(merged_data$event)

    cat("    æ ·æœ¬æ•°:", valid_samples,
        "| äº‹ä»¶æ•°:", total_events, "(High:", events_high, ", Low:", events_low, ")",
        "| p =", format(p_value, scientific = TRUE, digits = 3),
        "| HR =", round(hr, 3), "\n")

    # ä¿å­˜ç”Ÿå­˜æ›²çº¿
    figures_dir <- file.path("figures_multi_endpoint", endpoint, cancer_code)
    dir.create(figures_dir, showWarnings = FALSE, recursive = TRUE)

    p_surv <- ggsurvplot(
      fit,
      data = merged_data,
      pval = TRUE,
      pval.coord = c(0, 0.05),
      pval.size = 5,                    # å¢å¤§på€¼å­—ä½“
      conf.int = FALSE,
      risk.table = TRUE,
      risk.table.height = 0.25,
      xlab = "Time in days",
      ylab = "Survival probability",
      title = paste0(cancer_code, " (", cancer_names_cn[cancer_code], "): ",
                    ep_en, " [", endpoint, "]"),
      palette = c("#E41A1C", "#377EB8"), # é«˜å¯¹æ¯”åº¦é¢œè‰²ï¼šçº¢è‰²(High)å’Œè“è‰²(Low)
      legend.title = "CCR7+ mregDC",
      legend.labs = c("High", "Low"),
      size = 1.5,                        # å¢åŠ çº¿æ¡ç²—ç»†
      surv.median.line = "hv",           # æ˜¾ç¤ºä¸­ä½ç”Ÿå­˜æ—¶é—´
      ggtheme = theme_minimal(base_size = 14),  # å¢å¤§å­—ä½“
      tables.theme = theme_cleantable()  # ä¼˜åŒ–é£é™©è¡¨æ ¼æ ·å¼
    )

    # ä¿å­˜ç”Ÿå­˜æ›²çº¿ï¼ˆggsurvplotå¯¹è±¡éœ€è¦ä½¿ç”¨ä¼ ç»Ÿå›¾å½¢è®¾å¤‡ä¿å­˜ï¼‰
    # é«˜åˆ†è¾¨ç‡PDF
    pdf(file.path(figures_dir, "survival_curve.pdf"), width = 10, height = 8)
    print(p_surv)
    dev.off()

    # é«˜åˆ†è¾¨ç‡PNGï¼ˆ600 DPIï¼Œé€‚åˆå‡ºç‰ˆï¼‰
    png(file.path(figures_dir, "survival_curve.png"), width = 10, height = 8,
        units = "in", res = 600)
    print(p_surv)
    dev.off()

    # ============ è´¨é‡æ§åˆ¶æ£€æŸ¥ ============
    # æ£€æŸ¥æ ‡å‡†ï¼š
    # 1. æ€»äº‹ä»¶æ•° >= 10
    # 2. æ¯ç»„äº‹ä»¶æ•° >= 3
    # 3. HRåœ¨åˆç†èŒƒå›´å†… (0.01 < HR < 100)

    qc_issues <- c()
    qc_pass <- TRUE

    # æ£€æŸ¥1: æ€»äº‹ä»¶æ•°
    if(total_events < 10) {
      qc_pass <- FALSE
      qc_issues <- c(qc_issues, paste0("æ€»äº‹ä»¶æ•°ä¸è¶³(", total_events, "<10)"))
    }

    # æ£€æŸ¥2: æ¯ç»„äº‹ä»¶æ•°
    if(events_high < 3) {
      qc_pass <- FALSE
      qc_issues <- c(qc_issues, paste0("Highç»„äº‹ä»¶æ•°ä¸è¶³(", events_high, "<3)"))
    }
    if(events_low < 3) {
      qc_pass <- FALSE
      qc_issues <- c(qc_issues, paste0("Lowç»„äº‹ä»¶æ•°ä¸è¶³(", events_low, "<3)"))
    }

    # æ£€æŸ¥3: æç«¯HRå€¼
    if(hr > 100) {
      qc_pass <- FALSE
      qc_issues <- c(qc_issues, paste0("HRå€¼å¼‚å¸¸å¤§(", round(hr, 2), ">100)"))
    }
    if(hr < 0.01) {
      qc_pass <- FALSE
      qc_issues <- c(qc_issues, paste0("HRå€¼å¼‚å¸¸å°(", round(hr, 4), "<0.01)"))
    }

    # æ±‡æ€»è´¨é‡æ§åˆ¶çŠ¶æ€
    qc_summary <- if(qc_pass) "é€šè¿‡" else paste(qc_issues, collapse = "; ")

    # åœ¨æ§åˆ¶å°è¾“å‡ºè´¨é‡æ§åˆ¶ç»“æœ
    if(!qc_pass) {
      cat("    âš ï¸ è´¨é‡æ§åˆ¶æœªé€šè¿‡:", qc_summary, "\n")
    }

    # è¿”å›ç»“æœ
    summary_stats <- data.frame(
      Project = cancer_code,
      Cancer_Name_CN = cancer_names_cn[cancer_code],
      Endpoint = endpoint,
      Endpoint_CN = ep_cn,
      Total_samples = nrow(merged_data),
      High_group = sum(merged_data$group == "High"),
      Low_group = sum(merged_data$group == "Low"),
      Events = total_events,
      Events_High = events_high,
      Events_Low = events_low,
      LogRank_pvalue = p_value,
      Cox_HR = hr,
      Cox_pvalue = cox_pval,
      TPM_Anomaly = has_anomaly,
      TPM_Anomaly_Details = anomaly_summary,
      QC_Pass = qc_pass,
      QC_Issues = qc_summary,
      stringsAsFactors = FALSE
    )

    return(summary_stats)

  }, error = function(e) {
    cat("    âœ— é”™è¯¯:", conditionMessage(e), "\n")
    return(NULL)
  })

  return(result)
}

# å‡½æ•°ï¼šåˆ†æå•ä¸ªç™Œç—‡ç±»å‹çš„æ‰€æœ‰ç»“å±€
process_cancer_type_multi_endpoint <- function(cancer_code, exp_matrix, clinical) {

  cat("\n=================================================================\n")
  cat("å¤„ç†é¡¹ç›®: TCGA-", cancer_code, " (", cancer_names_cn[cancer_code], ")\n", sep="")
  cat("=================================================================\n")

  all_results <- list()

  for(endpoint in ENDPOINTS) {
    result <- process_single_endpoint(cancer_code, endpoint, exp_matrix, clinical)
    if(!is.null(result)) {
      all_results[[endpoint]] <- result
    }
  }

  if(length(all_results) > 0) {
    combined <- bind_rows(all_results)

    # ä¿å­˜è¯¥ç™Œç—‡çš„å¤šç»“å±€æ±‡æ€»
    results_dir <- file.path("results_multi_endpoint", cancer_code)
    dir.create(results_dir, showWarnings = FALSE, recursive = TRUE)
    write.csv(combined, file.path(results_dir, "multi_endpoint_summary.csv"),
              row.names = FALSE)

    cat("\nâœ“", cancer_code, "å®Œæˆ - æˆåŠŸåˆ†æ", nrow(combined), "ä¸ªç»“å±€\n")
    return(combined)
  } else {
    cat("\nâœ—", cancer_code, "å¤±è´¥ - æ‰€æœ‰ç»“å±€å‡æ— æ³•åˆ†æ\n")
    return(NULL)
  }
}
```

---

# 5. æ‰¹é‡åˆ†ææ‰€æœ‰ç™Œç—‡ç±»å‹ Ã— æ‰€æœ‰ç»“å±€

```{r process_all}
# è·å–æ‰€æœ‰ç™Œç—‡ç±»å‹
all_cancers <- unique(clin_data$cancer.type.abbreviation)
all_cancers <- all_cancers[!is.na(all_cancers)]
all_cancers <- all_cancers[all_cancers %in% names(cancer_names_cn)]
all_cancers <- sort(all_cancers)

cat("\næ‰¾åˆ°", length(all_cancers), "ä¸ªç™Œç—‡ç±»å‹\n")
cat("SignatureåŸºå› :", paste(SIGNATURE_GENES, collapse = ", "), "\n")
cat("æ ‡å‡†åŒ–åŸºå› :", NORMALIZER_GENE, "\n")
cat("ç”Ÿå­˜ç»“å±€:", paste(ENDPOINTS, collapse = ", "), "\n\n")

cat("å¼€å§‹å¤šç»“å±€åˆ†æï¼ˆé¢„è®¡è€—æ—¶2-4å°æ—¶ï¼‰...\n")

# å­˜å‚¨æ‰€æœ‰ç»“æœ
all_results <- list()

for(cancer in all_cancers) {
  result <- process_cancer_type_multi_endpoint(cancer, exp_data, clin_data)

  if(!is.null(result)) {
    all_results[[cancer]] <- result
  }
}

# åˆå¹¶æ‰€æœ‰ç»“æœ
if(length(all_results) > 0) {
  combined_all_results <- bind_rows(all_results)

  # ä¿å­˜æ€»æ±‡æ€»
  write.csv(combined_all_results,
            "results_multi_endpoint/pan_cancer_multi_endpoint_summary.csv",
            row.names = FALSE)

  cat("\n=================================================================\n")
  cat("âœ“ æ‰€æœ‰åˆ†æå®Œæˆï¼\n")
  cat("=================================================================\n")
  cat("æˆåŠŸåˆ†æ:", length(unique(combined_all_results$Project)), "ä¸ªç™Œç—‡ç±»å‹\n")
  cat("æ€»ç»“æœæ•°:", nrow(combined_all_results), "æ¡è®°å½•\n\n")
}
```

---

# 6. ç»“æœæ±‡æ€» - æŒ‰ç»“å±€åˆ†ç»„

```{r results_by_endpoint}
if(exists("combined_all_results") && nrow(combined_all_results) > 0) {

  cat("\n## å„ç”Ÿå­˜ç»“å±€çš„æ±‡æ€»ç»“æœ\n\n")

  for(endpoint in ENDPOINTS) {
    ep_cn <- ENDPOINT_NAMES_CN[endpoint]
    ep_desc <- ENDPOINT_DESC[endpoint]

    cat("\n### ", endpoint, " (", ep_cn, ")\n\n", sep="")
    cat("**å®šä¹‰**: ", ep_desc, "\n\n", sep="")

    ep_results <- combined_all_results %>%
      filter(Endpoint == endpoint) %>%
      arrange(LogRank_pvalue)

    # æ˜¾è‘—ç»“æœ
    ep_sig <- ep_results %>%
      filter(LogRank_pvalue < 0.05)

    cat("**æ˜¾è‘—ç›¸å…³çš„ç™Œç—‡ç±»å‹ (p < 0.05)**: ", nrow(ep_sig), " ä¸ª\n\n", sep="")

    if(nrow(ep_sig) > 0) {
      for(i in 1:nrow(ep_sig)) {
        hr_dir <- ifelse(ep_sig$Cox_HR[i] < 1, "ä¿æŠ¤æ€§", "é£é™©æ€§")
        cat(sprintf("- **%s** (%s): p = %s, HR = %.3f (%s)\n",
                    ep_sig$Project[i],
                    ep_sig$Cancer_Name_CN[i],
                    format(ep_sig$LogRank_pvalue[i], scientific = TRUE, digits = 3),
                    ep_sig$Cox_HR[i],
                    hr_dir))
      }
      cat("\n")
    } else {
      cat("*æ— æ˜¾è‘—ç›¸å…³çš„ç™Œç—‡ç±»å‹*\n\n")
    }

    cat("---\n\n")
  }
}
```

---

# 7. è·¨ç»“å±€å¯¹æ¯”åˆ†æ

```{r cross_endpoint_comparison}
if(exists("combined_all_results") && nrow(combined_all_results) > 0) {

  cat("\n## è·¨ç»“å±€å¯¹æ¯”åˆ†æ\n\n")

  # åˆ›å»ºå®½æ ¼å¼æ•°æ®ï¼šæ¯è¡Œæ˜¯ä¸€ä¸ªç™Œç—‡ï¼Œæ¯åˆ—æ˜¯ä¸€ä¸ªç»“å±€çš„på€¼
  wide_pval <- combined_all_results %>%
    select(Project, Cancer_Name_CN, Endpoint, LogRank_pvalue) %>%
    pivot_wider(names_from = Endpoint,
                values_from = LogRank_pvalue,
                names_prefix = "pval_")

  wide_hr <- combined_all_results %>%
    select(Project, Endpoint, Cox_HR) %>%
    pivot_wider(names_from = Endpoint,
                values_from = Cox_HR,
                names_prefix = "HR_")

  # åˆå¹¶
  wide_combined <- wide_pval %>%
    left_join(wide_hr, by = "Project")

  # è®¡ç®—æ¯ä¸ªç™Œç—‡åœ¨å¤šå°‘ä¸ªç»“å±€ä¸­æ˜¾è‘—
  wide_combined$N_Significant <- rowSums(wide_combined[,grep("^pval_", colnames(wide_combined))] < 0.05, na.rm = TRUE)

  # è¯†åˆ«åœ¨å¤šä¸ªç»“å±€ä¸­éƒ½æ˜¾è‘—çš„ç™Œç—‡
  multi_sig <- wide_combined %>%
    filter(N_Significant >= 2) %>%
    arrange(desc(N_Significant), Project)

  cat("### åœ¨å¤šä¸ªç»“å±€ä¸­éƒ½æ˜¾è‘—çš„ç™Œç—‡ç±»å‹ (â‰¥2ä¸ªç»“å±€ p < 0.05)\n\n")

  if(nrow(multi_sig) > 0) {
    cat("**å‘ç°", nrow(multi_sig), "ä¸ªç™Œç—‡ç±»å‹åœ¨å¤šä¸ªç»“å±€ä¸­æ˜¾è‘—ç›¸å…³:**\n\n")

    for(i in 1:nrow(multi_sig)) {
      cancer <- multi_sig$Project[i]
      cancer_cn <- multi_sig$Cancer_Name_CN[i]
      n_sig <- multi_sig$N_Significant[i]

      cat("#### ", i, ". **", cancer, "** (", cancer_cn, ") - ",
          n_sig, " ä¸ªç»“å±€æ˜¾è‘—\n\n", sep="")

      # æ˜¾ç¤ºæ¯ä¸ªç»“å±€çš„ç»“æœ
      cancer_results <- combined_all_results %>%
        filter(Project == cancer) %>%
        arrange(LogRank_pvalue)

      for(j in 1:nrow(cancer_results)) {
        ep <- cancer_results$Endpoint[j]
        ep_cn <- cancer_results$Endpoint_CN[j]
        pval <- cancer_results$LogRank_pvalue[j]
        hr <- cancer_results$Cox_HR[j]
        is_sig <- pval < 0.05
        sig_mark <- ifelse(is_sig, "âœ…", "â—‹")
        hr_dir <- ifelse(hr < 1, "ä¿æŠ¤æ€§", "é£é™©æ€§")

        cat(sprintf("  %s **%s** (%s): p = %s, HR = %.3f (%s)\n",
                    sig_mark, ep, ep_cn,
                    format(pval, scientific = TRUE, digits = 3),
                    hr, hr_dir))
      }

      cat("\n")
    }

    # ä¿å­˜å¤šç»“å±€æ˜¾è‘—ç™Œç—‡åˆ—è¡¨
    write.csv(multi_sig,
              "results_multi_endpoint/multi_endpoint_significant_cancers.csv",
              row.names = FALSE)

  } else {
    cat("*æœªå‘ç°åœ¨å¤šä¸ªç»“å±€ä¸­éƒ½æ˜¾è‘—çš„ç™Œç—‡ç±»å‹*\n\n")
  }

  cat("---\n\n")

  # æ¯ä¸ªç»“å±€çš„æ˜¾è‘—ç™Œç—‡æ•°ç»Ÿè®¡
  cat("### å„ç»“å±€çš„æ˜¾è‘—ç™Œç—‡æ•°é‡ç»Ÿè®¡\n\n")

  endpoint_sig_count <- combined_all_results %>%
    group_by(Endpoint, Endpoint_CN) %>%
    summarise(
      Total_cancers = n(),
      Significant = sum(LogRank_pvalue < 0.05),
      Marginal = sum(LogRank_pvalue >= 0.05 & LogRank_pvalue < 0.10),
      Non_significant = sum(LogRank_pvalue >= 0.10),
      .groups = "drop"
    ) %>%
    arrange(desc(Significant))

  kable(endpoint_sig_count,
        caption = "å„ç”Ÿå­˜ç»“å±€çš„æ˜¾è‘—ç™Œç—‡æ•°é‡",
        col.names = c("ç»“å±€", "ä¸­æ–‡å", "æ€»ç™Œç—‡æ•°", "æ˜¾è‘—(p<0.05)", "è¾¹ç¼˜æ˜¾è‘—(0.05â‰¤p<0.10)", "ä¸æ˜¾è‘—(pâ‰¥0.10)"))

  cat("\n")
}
```

---

# 8. ğŸ¯ å…³é”®ç»“æœæ€»ç»“

```{r key_findings}
if(exists("combined_all_results") && nrow(combined_all_results) > 0) {

  cat("\n## ğŸ¯ å…³é”®ç»“æœï¼šæœ‰é¢„åä»·å€¼çš„ç™Œç—‡ç±»å‹\n\n")

  # è¯†åˆ«å…³é”®ç™Œç—‡ï¼šåœ¨â‰¥2ä¸ªç»“å±€ä¸­æ˜¾è‘—ï¼Œæˆ–åœ¨ä»»ä¸€ç»“å±€ä¸­p<0.01
  key_cancers <- combined_all_results %>%
    group_by(Project, Cancer_Name_CN) %>%
    summarise(
      N_endpoints_sig = sum(LogRank_pvalue < 0.05),
      Min_pvalue = min(LogRank_pvalue),
      Best_endpoint = Endpoint[which.min(LogRank_pvalue)],
      .groups = "drop"
    ) %>%
    filter(N_endpoints_sig >= 2 | Min_pvalue < 0.01) %>%
    arrange(desc(N_endpoints_sig), Min_pvalue)

  if(nrow(key_cancers) > 0) {
    cat("### âœ… å‘ç°", nrow(key_cancers), "ä¸ªå…·æœ‰æ˜ç¡®é¢„åä»·å€¼çš„ç™Œç—‡ç±»å‹\n\n")
    cat("**æ ‡å‡†**: åœ¨â‰¥2ä¸ªç»“å±€ä¸­æ˜¾è‘—(p<0.05) æˆ– åœ¨ä»»ä¸€ç»“å±€ä¸­é«˜åº¦æ˜¾è‘—(p<0.01)\n\n")

    # ============ æ•°æ®è´¨é‡åˆ†ç±» ============
    # æ ¹æ®TPMè´¨é‡å’Œç»Ÿè®¡è´¨é‡æ§åˆ¶è¿›è¡Œåˆ†ç±»
    sig_results_with_qc <- combined_all_results %>%
      filter(LogRank_pvalue < 0.05) %>%
      select(Project, Cancer_Name_CN, Endpoint, Endpoint_CN,
             Events, Events_High, Events_Low,
             LogRank_pvalue, Cox_HR, Cox_pvalue,
             TPM_Anomaly, TPM_Anomaly_Details,
             QC_Pass, QC_Issues)

    # æŒ‰ç™Œç—‡åˆ†ç»„ç»Ÿè®¡è´¨é‡çŠ¶æ€
    sig_cancer_qc_status <- sig_results_with_qc %>%
      group_by(Project, Cancer_Name_CN) %>%
      summarise(
        N_sig_endpoints = n(),
        N_qc_pass = sum(QC_Pass & !TPM_Anomaly),  # å®Œå…¨é€šè¿‡ï¼šç»Ÿè®¡è´¨é‡å’ŒTPMéƒ½æ­£å¸¸
        N_qc_fail = sum(!QC_Pass),                 # ç»Ÿè®¡è´¨é‡é—®é¢˜
        N_tpm_fail = sum(TPM_Anomaly & QC_Pass),   # ä»…TPMé—®é¢˜
        Has_any_issue = any(!QC_Pass | TPM_Anomaly),
        .groups = "drop"
      )

    # åˆ†ç±»1ï¼šå®Œå…¨å¯ä¿¡ï¼ˆç»Ÿè®¡è´¨é‡å’ŒTPMè´¨é‡éƒ½é€šè¿‡ï¼‰
    reliable_cancers <- sig_cancer_qc_status %>%
      filter(!Has_any_issue) %>%
      arrange(desc(N_sig_endpoints))

    # åˆ†ç±»2ï¼šæœ‰è´¨é‡é—®é¢˜ï¼ˆç»Ÿè®¡è´¨é‡æˆ–TPMè´¨é‡æœªé€šè¿‡ï¼‰
    unreliable_cancers <- sig_cancer_qc_status %>%
      filter(Has_any_issue) %>%
      arrange(desc(N_sig_endpoints))

    cat("#### ğŸ“Š æ˜¾è‘—ç»“æœçš„æ•°æ®è´¨é‡åˆ†ç±»\n\n")
    cat("**è´¨é‡æ§åˆ¶æ ‡å‡†**ï¼š\n")
    cat("- âœ… **ç»Ÿè®¡è´¨é‡**ï¼šæ€»äº‹ä»¶æ•°â‰¥10ï¼Œæ¯ç»„äº‹ä»¶æ•°â‰¥3ï¼Œ0.01<HR<100\n")
    cat("- âœ… **TPMè´¨é‡**ï¼šæ‰€æœ‰signatureåŸºå› æ— è´Ÿå€¼æˆ–å¼‚å¸¸å¤§å€¼\n")
    cat("- âš ï¸ **ä¸ç¬¦åˆä»¥ä¸Šä»»ä¸€æ ‡å‡†çš„ç»“æœå°†è¢«æ ‡è®°ä¸ºä¸å¯ä¿¡**\n\n")

    if(nrow(reliable_cancers) > 0) {
      cat("##### âœ… å®Œå…¨å¯ä¿¡çš„æ˜¾è‘—ç»“æœï¼ˆé€šè¿‡æ‰€æœ‰è´¨é‡æ£€æŸ¥ï¼‰: ", nrow(reliable_cancers), " ä¸ªç™Œç—‡\n\n", sep="")
      cat("**è¿™äº›ç™Œç—‡çš„æ˜¾è‘—ç»“æœå¯ä»¥æ”¾å¿ƒä½¿ç”¨**ï¼ˆç»Ÿè®¡è´¨é‡âœ… + TPMè´¨é‡âœ…ï¼‰ï¼š\n\n")

      for(i in 1:nrow(reliable_cancers)) {
        cancer <- reliable_cancers$Project[i]
        cancer_cn <- reliable_cancers$Cancer_Name_CN[i]
        n_sig <- reliable_cancers$N_sig_endpoints[i]

        cat("- **", cancer, "** (", cancer_cn, "): ", n_sig, " ä¸ªæ˜¾è‘—ç»“å±€\n", sep="")

        # æ˜¾ç¤ºå…·ä½“çš„æ˜¾è‘—ç»“å±€å’ŒæŒ‡æ ‡ï¼ˆåªæ˜¾ç¤ºå®Œå…¨é€šè¿‡è´¨é‡æ£€æŸ¥çš„ï¼‰
        cancer_sig_details <- sig_results_with_qc %>%
          filter(Project == cancer, QC_Pass, !TPM_Anomaly) %>%
          arrange(LogRank_pvalue)

        for(j in 1:nrow(cancer_sig_details)) {
          ep <- cancer_sig_details$Endpoint[j]
          ep_cn <- cancer_sig_details$Endpoint_CN[j]
          hr <- cancer_sig_details$Cox_HR[j]
          pval <- cancer_sig_details$LogRank_pvalue[j]
          events <- cancer_sig_details$Events[j]
          events_h <- cancer_sig_details$Events_High[j]
          events_l <- cancer_sig_details$Events_Low[j]

          cat("  - ", ep, " (", ep_cn, "): HR = ",
              format(hr, digits = 3, nsmall = 2),
              ", p = ", format(pval, scientific = TRUE, digits = 2),
              " [äº‹ä»¶æ•°: ", events, " (H:", events_h, "/L:", events_l, ")]\n", sep="")
        }
      }
      cat("\n")
    }

    if(nrow(unreliable_cancers) > 0) {
      cat("##### âš ï¸ ä¸å¯ä¿¡çš„æ˜¾è‘—ç»“æœï¼ˆå­˜åœ¨æ•°æ®è´¨é‡é—®é¢˜ï¼‰: ", nrow(unreliable_cancers), " ä¸ªç™Œç—‡\n\n", sep="")
      cat("**è­¦å‘Šï¼šè¿™äº›ç™Œç—‡è™½ç„¶æ˜¾ç¤ºç»Ÿè®¡æ˜¾è‘—æ€§ï¼Œä½†æ•°æ®è´¨é‡ä¸ç¬¦åˆæ ‡å‡†ï¼Œç»“æœä¸å¯é ï¼Œä¸åº”ä½¿ç”¨**ï¼š\n\n")

      for(i in 1:nrow(unreliable_cancers)) {
        cancer <- unreliable_cancers$Project[i]
        cancer_cn <- unreliable_cancers$Cancer_Name_CN[i]
        n_sig <- unreliable_cancers$N_sig_endpoints[i]
        n_qc_fail <- unreliable_cancers$N_qc_fail[i]
        n_tpm_fail <- unreliable_cancers$N_tpm_fail[i]

        cat("- **", cancer, "** (", cancer_cn, "): ", n_sig, " ä¸ªæ˜¾è‘—ç»“å±€\n", sep="")

        # æ˜¾ç¤ºç»Ÿè®¡è´¨é‡é—®é¢˜çš„ç»“å±€
        if(n_qc_fail > 0) {
          cancer_qc_issues <- sig_results_with_qc %>%
            filter(Project == cancer, !QC_Pass)

          cat("  - ğŸš« **ç»Ÿè®¡è´¨é‡é—®é¢˜** (", n_qc_fail, "ä¸ªç»“å±€): ", sep="")
          for(j in 1:nrow(cancer_qc_issues)) {
            ep <- cancer_qc_issues$Endpoint[j]
            qc_issue <- cancer_qc_issues$QC_Issues[j]
            hr <- cancer_qc_issues$Cox_HR[j]
            events <- cancer_qc_issues$Events[j]

            cat("\n    - ", ep, ": ", qc_issue, sep="")
            if(hr > 100 || hr < 0.01) {
              cat(" [HR=", format(hr, scientific = TRUE, digits = 2), "]", sep="")
            }
          }
          cat("\n")
        }

        # æ˜¾ç¤ºTPMè´¨é‡é—®é¢˜çš„ç»“å±€ï¼ˆä½†ç»Ÿè®¡è´¨é‡é€šè¿‡ï¼‰
        if(n_tpm_fail > 0) {
          cancer_tpm_issues <- sig_results_with_qc %>%
            filter(Project == cancer, QC_Pass, TPM_Anomaly)

          cat("  - âš ï¸ **TPMæ•°æ®é—®é¢˜** (", n_tpm_fail, "ä¸ªç»“å±€): ", sep="")
          for(j in 1:nrow(cancer_tpm_issues)) {
            ep <- cancer_tpm_issues$Endpoint[j]
            tpm_detail <- cancer_tpm_issues$TPM_Anomaly_Details[j]

            cat("\n    - ", ep, ": ", tpm_detail, sep="")
          }
          cat("\n")
        }
        cat("\n")
      }
    }

    cat("---\n\n")

    # åŸæœ‰çš„è¯¦ç»†åˆ—è¡¨ï¼ˆåªå±•ç¤ºå¯ä¿¡çš„ç™Œç—‡ï¼‰
    if(nrow(reliable_cancers) > 0) {
      cat("### ğŸ“‹ å¯ä¿¡ç»“æœè¯¦ç»†æŠ¥å‘Š\n\n")
      cat("ä»¥ä¸‹ä»…å±•ç¤º**é€šè¿‡æ‰€æœ‰è´¨é‡æ£€æŸ¥**çš„ç™Œç—‡ç±»å‹è¯¦ç»†ç»“æœï¼ˆç»Ÿè®¡è´¨é‡âœ… + TPMè´¨é‡âœ…ï¼‰ï¼š\n\n")

      display_cancers <- key_cancers %>%
        filter(Project %in% reliable_cancers$Project)

      for(i in 1:nrow(display_cancers)) {
        cancer <- display_cancers$Project[i]
        cancer_cn <- display_cancers$Cancer_Name_CN[i]
        n_sig <- display_cancers$N_endpoints_sig[i]
        min_p <- display_cancers$Min_pvalue[i]
        best_ep <- display_cancers$Best_endpoint[i]

        cat("#### ", i, ". **", cancer, "** (", cancer_cn, ") âœ…\n\n", sep="")

        cat("- **æ˜¾è‘—ç»“å±€æ•°**: ", n_sig, " / ", length(ENDPOINTS), "\n", sep="")
        cat("- **æœ€ä½³ç»“å±€**: ", best_ep, " (", ENDPOINT_NAMES_CN[best_ep],
            "), p = ", format(min_p, scientific = TRUE, digits = 3), "\n", sep="")

        # è¯¦ç»†ç»“æœ
        cancer_details <- combined_all_results %>%
          filter(Project == cancer) %>%
          arrange(LogRank_pvalue)

        cat("\n**å„ç»“å±€è¯¦ç»†ç»“æœ**:\n\n")
        cat("| ç»“å±€ | ä¸­æ–‡å | æ ·æœ¬æ•° | äº‹ä»¶æ•° | Log-rank på€¼ | Cox HR | TPMçŠ¶æ€ | è§£è¯» |\n")
        cat("|------|--------|--------|--------|--------------|--------|---------|------|\n")

        for(j in 1:nrow(cancer_details)) {
          ep <- cancer_details$Endpoint[j]
          ep_cn <- cancer_details$Endpoint_CN[j]
          n_samples <- cancer_details$Total_samples[j]
          n_events <- cancer_details$Events[j]
          pval <- cancer_details$LogRank_pvalue[j]
          hr <- cancer_details$Cox_HR[j]
          tpm_status <- if(cancer_details$TPM_Anomaly[j]) "âŒå¼‚å¸¸" else "âœ…æ­£å¸¸"

          sig_mark <- ifelse(pval < 0.01, "âœ…âœ…",
                            ifelse(pval < 0.05, "âœ…", "â—‹"))
          hr_dir <- ifelse(hr < 1, "Highç»„ç”Ÿå­˜æ›´å¥½", "Lowç»„ç”Ÿå­˜æ›´å¥½")

          cat(sprintf("| %s %s | %s | %d | %d | %s | %.3f | %s | %s |\n",
                      sig_mark, ep, ep_cn, n_samples, n_events,
                      format(pval, scientific = TRUE, digits = 3),
                      hr, tpm_status, hr_dir))
        }

        cat("\n**ç”Ÿå­˜æ›²çº¿ä½ç½®**:\n")
        for(ep in ENDPOINTS) {
          if(file.exists(file.path("figures_multi_endpoint", ep, cancer, "survival_curve.pdf"))) {
            cat("- ", ep, ": `figures_multi_endpoint/", ep, "/", cancer, "/survival_curve.pdf`\n", sep="")
          }
        }

        cat("\n---\n\n")
      }
    }

    # ä¿å­˜å¯ä¿¡çš„ç™Œç—‡åˆ—è¡¨
    if(nrow(reliable_cancers) > 0) {
      write.csv(reliable_cancers,
                "results_multi_endpoint/reliable_significant_cancers.csv",
                row.names = FALSE)
      cat("\nğŸ’¾ **å¯ä¿¡çš„æ˜¾è‘—ç™Œç—‡åˆ—è¡¨å·²ä¿å­˜**: `results_multi_endpoint/reliable_significant_cancers.csv`\n\n")
    }

    # ä¿å­˜æ‰€æœ‰å…³é”®ç™Œç—‡åˆ—è¡¨ï¼ˆåŒ…å«å¯ä¿¡å’Œä¸å¯ä¿¡ï¼‰
    write.csv(key_cancers,
              "results_multi_endpoint/key_prognostic_cancers.csv",
              row.names = FALSE)
    cat("ğŸ’¾ **æ‰€æœ‰å…³é”®ç™Œç—‡åˆ—è¡¨å·²ä¿å­˜**: `results_multi_endpoint/key_prognostic_cancers.csv`\n\n")

  } else {
    cat("### âš ï¸ æœªå‘ç°ç¬¦åˆæ ‡å‡†çš„å…³é”®ç™Œç—‡ç±»å‹\n\n")
    cat("å»ºè®®:\n")
    cat("- è€ƒè™‘è°ƒæ•´signatureå®šä¹‰\n")
    cat("- å°è¯•å…¶ä»–åˆ†ææ–¹æ³•\n\n")
  }

  cat("---\n\n")

  # ç»“å±€ä¼˜å…ˆçº§å»ºè®®
  cat("### ğŸ“Š ç»“å±€é€‰æ‹©å»ºè®®\n\n")

  endpoint_priority <- combined_all_results %>%
    group_by(Endpoint, Endpoint_CN) %>%
    summarise(
      N_significant = sum(LogRank_pvalue < 0.05),
      Mean_HR = mean(Cox_HR[LogRank_pvalue < 0.05], na.rm = TRUE),
      .groups = "drop"
    ) %>%
    arrange(desc(N_significant))

  if(nrow(endpoint_priority) > 0) {
    best_endpoint <- endpoint_priority$Endpoint[1]
    best_ep_cn <- endpoint_priority$Endpoint_CN[1]
    best_n_sig <- endpoint_priority$N_significant[1]

    cat("**æœ€æœ‰é¢„åä»·å€¼çš„ç»“å±€**: ", best_endpoint, " (", best_ep_cn, ")\n", sep="")
    cat("- æ˜¾è‘—ç™Œç—‡æ•°: ", best_n_sig, " ä¸ª\n", sep="")
    cat("- æè¿°: ", ENDPOINT_DESC[best_endpoint], "\n\n", sep="")

    cat("**å„ç»“å±€é¢„åä»·å€¼æ’åº**:\n\n")
    for(i in 1:nrow(endpoint_priority)) {
      ep <- endpoint_priority$Endpoint[i]
      ep_cn <- endpoint_priority$Endpoint_CN[i]
      n_sig <- endpoint_priority$N_significant[i]

      cat(sprintf("%d. **%s** (%s): %d ä¸ªæ˜¾è‘—ç™Œç—‡\n",
                  i, ep, ep_cn, n_sig))
    }
    cat("\n")
  }
}
```

---

# 9. ğŸ“‹ æ•°æ®è´¨é‡æ§åˆ¶æŠ¥å‘Š

## 9.1 ç»Ÿè®¡è´¨é‡æ§åˆ¶ï¼šä¸ç¬¦åˆæ ‡å‡†çš„ç»“æœ

```{r statistical_quality_control}
if(exists("combined_all_results") && nrow(combined_all_results) > 0) {

  cat("\n## ç»Ÿè®¡è´¨é‡æ§åˆ¶æ£€æŸ¥\n\n")

  cat("**è´¨é‡æ ‡å‡†**ï¼š\n")
  cat("1. **æ€»äº‹ä»¶æ•°** â‰¥ 10\n")
  cat("2. **æ¯ç»„äº‹ä»¶æ•°** â‰¥ 3 (Highç»„å’ŒLowç»„åˆ†åˆ«)\n")
  cat("3. **HRå€¼åˆç†èŒƒå›´**: 0.01 < HR < 100\n\n")

  cat("**è¯´æ˜**: ä¸ç¬¦åˆä»¥ä¸Šä»»ä¸€æ ‡å‡†çš„ç»“æœè¢«è§†ä¸º**ç»Ÿè®¡ä¸å¯é **ï¼Œé€šå¸¸ç”±äºï¼š\n")
  cat("- æ ·æœ¬é‡ä¸è¶³\n")
  cat("- äº‹ä»¶æ•°å¤ªå°‘ï¼ˆå®Œå…¨æˆ–å‡†å®Œå…¨åˆ†ç¦»ï¼‰\n")
  cat("- éšè®¿æ—¶é—´ä¸è¶³\n\n")

  # ç­›é€‰æœªé€šè¿‡è´¨é‡æ§åˆ¶çš„è®°å½•ï¼ˆæ˜¾è‘—çš„ï¼‰
  qc_failures <- combined_all_results %>%
    filter(LogRank_pvalue < 0.05, !QC_Pass)

  if(nrow(qc_failures) > 0) {
    cat("### âš ï¸ å‘ç°", nrow(qc_failures), "æ¡æ˜¾è‘—ç»“æœæœªé€šè¿‡ç»Ÿè®¡è´¨é‡æ§åˆ¶\n\n")
    cat("**é‡è¦è­¦å‘Š**: ä»¥ä¸‹ç»“æœè™½ç„¶p<0.05ï¼Œä½†ç»Ÿè®¡è´¨é‡ä¸è¶³ï¼Œ**ä¸åº”ä½¿ç”¨**ï¼\n\n")

    # æŒ‰ç™Œç—‡åˆ†ç»„æ±‡æ€»
    qc_fail_by_cancer <- qc_failures %>%
      group_by(Project, Cancer_Name_CN) %>%
      summarise(
        Affected_Endpoints = paste(Endpoint, collapse = ", "),
        N_Affected = n(),
        Issues = paste(unique(QC_Issues), collapse = "; "),
        .groups = "drop"
      ) %>%
      arrange(desc(N_Affected), Project)

    cat("#### å—å½±å“çš„ç™Œç—‡ç±»å‹æ±‡æ€»\n\n")

    for(i in 1:nrow(qc_fail_by_cancer)) {
      cancer <- qc_fail_by_cancer$Project[i]
      cancer_cn <- qc_fail_by_cancer$Cancer_Name_CN[i]
      n_affected <- qc_fail_by_cancer$N_Affected[i]
      endpoints <- qc_fail_by_cancer$Affected_Endpoints[i]
      issues <- qc_fail_by_cancer$Issues[i]

      cat("##### ", i, ". **", cancer, "** (", cancer_cn, ") ğŸš«\n\n", sep="")
      cat("- **å—å½±å“çš„ç»“å±€**: ", endpoints, " (", n_affected, " / ", length(ENDPOINTS), ")\n", sep="")
      cat("- **è´¨é‡é—®é¢˜**: ", issues, "\n", sep="")
      cat("- **æ•°æ®å¯ç”¨æ€§**: â›” **ä¸å¯ç”¨** - æ ·æœ¬é‡æˆ–äº‹ä»¶æ•°ä¸è¶³\n")
      cat("- **å»ºè®®**: éœ€è¦æ›´å¤§æ ·æœ¬é‡æˆ–æ›´é•¿éšè®¿æ—¶é—´éªŒè¯\n\n")
    }

    # è¯¦ç»†åˆ—è¡¨
    cat("\n#### è¯¦ç»†é—®é¢˜åˆ—è¡¨\n\n")

    qc_failures_sorted <- qc_failures %>%
      arrange(Project, Endpoint)

    for(i in 1:nrow(qc_failures_sorted)) {
      row <- qc_failures_sorted[i,]
      cat("- **", row$Project, " - ", row$Endpoint, "**: ",
          "äº‹ä»¶æ•°=", row$Events, " (H:", row$Events_High, "/L:", row$Events_Low, "), ",
          "HR=", format(row$Cox_HR, scientific = TRUE, digits = 2), " | ",
          row$QC_Issues, "\n", sep="")
    }

    # ä¿å­˜è´¨é‡æ§åˆ¶å¤±è´¥çš„åˆ—è¡¨
    write.csv(qc_failures,
              "results_multi_endpoint/qc_failures.csv",
              row.names = FALSE)
    cat("\n> âœ“ è´¨é‡æ§åˆ¶å¤±è´¥çš„è¯¦ç»†åˆ—è¡¨å·²ä¿å­˜è‡³: `results_multi_endpoint/qc_failures.csv`\n\n")

  } else {
    cat("### âœ… æ‰€æœ‰æ˜¾è‘—ç»“æœå‡é€šè¿‡ç»Ÿè®¡è´¨é‡æ§åˆ¶\n\n")
  }

  # ç»Ÿè®¡æ‰€æœ‰ç»“æœçš„è´¨é‡çŠ¶æ€ï¼ˆåŒ…æ‹¬éæ˜¾è‘—çš„ï¼‰
  cat("\n### ğŸ“Š æ•´ä½“è´¨é‡æ§åˆ¶ç»Ÿè®¡\n\n")

  qc_stats <- combined_all_results %>%
    summarise(
      Total = n(),
      QC_Pass = sum(QC_Pass),
      QC_Fail = sum(!QC_Pass),
      Pass_Rate = round(100 * sum(QC_Pass) / n(), 1)
    )

  cat("- **æ€»åˆ†ææ•°**: ", qc_stats$Total, " æ¡è®°å½•\n", sep="")
  cat("- **é€šè¿‡è´¨é‡æ§åˆ¶**: ", qc_stats$QC_Pass, " æ¡ (", qc_stats$Pass_Rate, "%)\n", sep="")
  cat("- **æœªé€šè¿‡è´¨é‡æ§åˆ¶**: ", qc_stats$QC_Fail, " æ¡ (", 100-qc_stats$Pass_Rate, "%)\n\n", sep="")
}
```

---

## 9.2 TPMæ•°æ®è´¨é‡ï¼šè½¬æ¢å¼‚å¸¸æŠ¥å‘Š

```{r tpm_quality_control}
if(exists("combined_all_results") && nrow(combined_all_results) > 0) {

  cat("\n## TPMè½¬æ¢è´¨é‡æ£€æŸ¥\n\n")

  cat("**æ£€æŸ¥ç›®çš„**: ç¡®ä¿æ‰€æœ‰åŸºå› è¡¨è¾¾æ•°æ®æ­£ç¡®ä» log2(TPM+1) è½¬æ¢åˆ° TPM ç©ºé—´\n\n")

  # ç­›é€‰æœ‰TPMå¼‚å¸¸çš„è®°å½•
  tpm_anomalies <- combined_all_results %>%
    filter(TPM_Anomaly == TRUE)

  if(nrow(tpm_anomalies) > 0) {
    cat("### âš ï¸ å‘ç°", nrow(tpm_anomalies), "æ¡è®°å½•å­˜åœ¨TPMå¼‚å¸¸\n\n")

    cat("**é‡è¦è­¦å‘Š**: ä»¥ä¸‹ç™Œç—‡ç±»å‹åœ¨æŒ‡å®šç»“å±€ä¸­çš„æ•°æ®å­˜åœ¨TPMå¼‚å¸¸ï¼Œ**ä¸åº”ä½¿ç”¨è¿™äº›ç»“æœ**ï¼\n\n")

    # æŒ‰ç™Œç—‡åˆ†ç»„æ±‡æ€»
    anomaly_by_cancer <- tpm_anomalies %>%
      group_by(Project, Cancer_Name_CN) %>%
      summarise(
        Affected_Endpoints = paste(Endpoint, collapse = ", "),
        N_Affected = n(),
        Details = paste(unique(TPM_Anomaly_Details), collapse = "; "),
        .groups = "drop"
      ) %>%
      arrange(desc(N_Affected), Project)

    cat("#### å—å½±å“çš„ç™Œç—‡ç±»å‹æ±‡æ€»\n\n")

    for(i in 1:nrow(anomaly_by_cancer)) {
      cancer <- anomaly_by_cancer$Project[i]
      cancer_cn <- anomaly_by_cancer$Cancer_Name_CN[i]
      n_affected <- anomaly_by_cancer$N_Affected[i]
      endpoints <- anomaly_by_cancer$Affected_Endpoints[i]
      details <- anomaly_by_cancer$Details[i]

      cat("##### ", i, ". **", cancer, "** (", cancer_cn, ") âŒ\n\n", sep="")
      cat("- **å—å½±å“çš„ç»“å±€**: ", endpoints, " (", n_affected, " / ", length(ENDPOINTS), ")\n", sep="")
      cat("- **å¼‚å¸¸è¯¦æƒ…**: ", details, "\n", sep="")
      cat("- **æ•°æ®å¯ç”¨æ€§**: â›” **ä¸å¯ç”¨** - æ•°æ®è½¬æ¢å­˜åœ¨é—®é¢˜\n")
      cat("- **å»ºè®®**: æ£€æŸ¥åŸå§‹æ•°æ®è´¨é‡ï¼Œæˆ–ä»åˆ†æä¸­æ’é™¤è¯¥ç™Œç—‡ç±»å‹\n\n")
    }

    # è¯¦ç»†åˆ—è¡¨
    cat("\n#### è¯¦ç»†å¼‚å¸¸åˆ—è¡¨\n\n")
    cat("| ç™Œç—‡ | ä¸­æ–‡å | ç»“å±€ | å¼‚å¸¸åŸºå› ä¸åŸå›  |\n")
    cat("|------|--------|------|----------------|\n")

    for(i in 1:nrow(tpm_anomalies)) {
      cat(sprintf("| %s | %s | %s | %s |\n",
                  tpm_anomalies$Project[i],
                  tpm_anomalies$Cancer_Name_CN[i],
                  tpm_anomalies$Endpoint[i],
                  tpm_anomalies$TPM_Anomaly_Details[i]))
    }

    cat("\n")

    # ä¿å­˜å¼‚å¸¸è®°å½•
    write.csv(tpm_anomalies,
              "results_multi_endpoint/TPM_anomalies.csv",
              row.names = FALSE)
    cat("ğŸ’¾ **TPMå¼‚å¸¸è®°å½•å·²ä¿å­˜**: `results_multi_endpoint/TPM_anomalies.csv`\n\n")

    # ç»Ÿè®¡å¼‚å¸¸ç±»å‹
    cat("### ğŸ“Š å¼‚å¸¸ç±»å‹ç»Ÿè®¡\n\n")

    # ç»Ÿè®¡è´Ÿæ•°å¼‚å¸¸
    n_negative <- sum(grepl("è´Ÿæ•°", tpm_anomalies$TPM_Anomaly_Details))
    # ç»Ÿè®¡å¼‚å¸¸å¤§å€¼
    n_large <- sum(grepl("å¼‚å¸¸å¤§", tpm_anomalies$TPM_Anomaly_Details))

    cat("- **è´Ÿæ•°å¼‚å¸¸**: ", n_negative, " æ¡è®°å½•\n", sep="")
    cat("  - åŸå› : æ•°æ®è½¬æ¢å…¬å¼é”™è¯¯æˆ–åŸå§‹æ•°æ®æŸå\n")
    cat("  - å½±å“: TPMå€¼ä¸åº”è¯¥æœ‰è´Ÿæ•°\n\n")

    cat("- **å¼‚å¸¸å¤§å€¼**: ", n_large, " æ¡è®°å½•\n", sep="")
    cat("  - åŸå› : æ•°æ®æŸåã€è½¬æ¢å…¬å¼é”™è¯¯æˆ–æ•°æ®å•ä½ä¸å¯¹\n")
    cat("  - å½±å“: æ­£å¸¸åŸºå› è¡¨è¾¾å¾ˆå°‘è¶…è¿‡100,000 TPM\n\n")

    cat("---\n\n")

  } else {
    cat("### âœ… æ‰€æœ‰æ•°æ®é€šè¿‡TPMè´¨é‡æ£€æŸ¥\n\n")
    cat("**ç»“æœ**: æ‰€æœ‰", nrow(combined_all_results), "æ¡åˆ†æè®°å½•çš„åŸºå› è¡¨è¾¾æ•°æ®å‡å·²æ­£ç¡®è½¬æ¢åˆ°TPMç©ºé—´ã€‚\n\n")

    cat("**éªŒè¯é¡¹ç›®**:\n")
    cat("- âœ… æ‰€æœ‰åŸºå› TPMå€¼å‡ä¸ºéè´Ÿæ•°\n")
    cat("- âœ… æ‰€æœ‰åŸºå› TPMå€¼åœ¨åˆç†èŒƒå›´å†… (< 100,000)\n")
    cat("- âœ… æ•°æ®è½¬æ¢å…¬å¼æ­£ç¡®: TPM = 2^log2(TPM+1) - 1\n\n")

    cat("**ç»“è®º**: æ‰€æœ‰åˆ†æç»“æœå‡å¯ä¿¡èµ–ï¼Œæ•°æ®è´¨é‡è‰¯å¥½ã€‚\n\n")
  }

  # æ— è®ºæ˜¯å¦æœ‰å¼‚å¸¸ï¼Œéƒ½æ˜¾ç¤ºè´¨é‡æ§åˆ¶æ ‡å‡†
  cat("### ğŸ“– TPMè´¨é‡æ§åˆ¶æ ‡å‡†\n\n")

  cat("**æ­£å¸¸TPMèŒƒå›´** (RNA-seq):\n")
  cat("- ä½è¡¨è¾¾åŸºå› : 0-10 TPM\n")
  cat("- ä¸­ç­‰è¡¨è¾¾: 10-100 TPM\n")
  cat("- é«˜è¡¨è¾¾: 100-10,000 TPM\n")
  cat("- æé«˜è¡¨è¾¾ (ç®¡å®¶åŸºå› ): 10,000-50,000 TPM\n\n")

  cat("**å¼‚å¸¸åˆ¤å®šé˜ˆå€¼**:\n")
  cat("- âš ï¸ **è´Ÿæ•°** (< 0): ç»å¯¹ä¸åº”è¯¥å‡ºç°ï¼Œè¯´æ˜è½¬æ¢é”™è¯¯\n")
  cat("- âš ï¸ **å¼‚å¸¸å¤§** (> 100,000): ç½•è§ï¼Œå¯èƒ½æ˜¯æ•°æ®é—®é¢˜\n\n")

  cat("**æˆ‘ä»¬çš„signatureåŸºå› é¢„æœŸèŒƒå›´**:\n")
  cat("- CCR7, LAMP3, FSCN1: 0-5,000 TPM (å…ç–«ç»†èƒæ ‡å¿—ç‰©)\n")
  cat("- CD3G: 0-10,000 TPM (Tç»†èƒé«˜è¡¨è¾¾)\n\n")
}
```

---

# 10. ä¼šè¯ä¿¡æ¯

```{r session_info}
sessionInfo()
```

---

# æ€»ç»“

æœ¬åˆ†æä½¿ç”¨**UCSC Xena TCGA Pan-Cancer Atlasæ•°æ®**ï¼ˆLiu et al. Cell 2018ï¼‰ï¼Œå¯¹CCR7+ mregDC signatureè¿›è¡Œäº†**å¤šç»“å±€ç”Ÿå­˜åˆ†æ**ã€‚

**Signatureå®šä¹‰**: `r SIGNATURE_NAME`

**åˆ†æçš„4ä¸ªç”Ÿå­˜ç»“å±€**:
```{r summary_endpoints, echo=FALSE, results='asis'}
for(ep in ENDPOINTS) {
  cat("- **", ep, "** (", ENDPOINT_NAMES_CN[ep], "): ", ENDPOINT_DESC[ep], "\n", sep="")
}
```

**ä¸»è¦å‘ç°**:
- å…¨é¢è¯„ä¼°äº†signatureåœ¨4ä¸ªæ ‡å‡†åŒ–ç”Ÿå­˜ç»“å±€ä¸­çš„é¢„åä»·å€¼
- è¯†åˆ«äº†åœ¨å¤šä¸ªç»“å±€ä¸­éƒ½æ˜¾è‘—çš„ç™Œç—‡ç±»å‹
- ä¸ºåç»­æ·±å…¥ç ”ç©¶æä¾›äº†æ–¹å‘

**æ•°æ®æ¥æº**:
- Liu J, et al. An Integrated TCGA Pan-Cancer Clinical Data Resource to Drive High-Quality Survival Outcome Analytics. Cell. 2018.
- UCSC Xena - TCGA Pan-Cancer Atlas Hub

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: `r Sys.time()`
